# Complete Backend Files for Smart Booking System

## 1. Main Server File - server.js
```javascript
const express = require('express')
const dotenv = require('dotenv')
const cors = require('cors')
const cookieParser = require('cookie-parser')
const morgan = require('morgan')
const helmet = require('helmet')
const rateLimit = require('express-rate-limit')
const mongoSanitize = require('express-mongo-sanitize')
const xss = require('xss-clean')
const hpp = require('hpp')

// Load environment variables
dotenv.config()

// Import database connection
const connectDB = require('./src/config/database')

// Import error handler
const errorHandler = require('./src/middleware/errorHandler')

// Import routes
const authRoutes = require('./src/routes/auth')
const userRoutes = require('./src/routes/users')
const serviceRoutes = require('./src/routes/services')
const providerRoutes = require('./src/routes/providers')
const bookingRoutes = require('./src/routes/bookings')
const dashboardRoutes = require('./src/routes/dashboard')
const uploadRoutes = require('./src/routes/upload')

// Connect to database
connectDB()

const app = express()

// Security middleware
app.use(helmet())

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100 // limit each IP to 100 requests per windowMs
})
app.use(limiter)

// Body parser middleware
app.use(express.json({ limit: '10mb' }))
app.use(express.urlencoded({ extended: false }))

// Cookie parser middleware
app.use(cookieParser())

// Data sanitization against NoSQL query injection
app.use(mongoSanitize())

// Data sanitization against XSS
app.use(xss())

// Prevent parameter pollution
app.use(hpp())

// Enable CORS
app.use(cors({
  origin: process.env.CLIENT_URL || 'http://localhost:3000',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
}))

// Dev logging middleware
if (process.env.NODE_ENV === 'development') {
  app.use(morgan('dev'))
}

// Static folder for file uploads
app.use('/uploads', express.static('uploads'))

// API Routes
app.use('/api/auth', authRoutes)
app.use('/api/users', userRoutes)
app.use('/api/services', serviceRoutes)
app.use('/api/providers', providerRoutes)
app.use('/api/bookings', bookingRoutes)
app.use('/api/dashboard', dashboardRoutes)
app.use('/api/upload', uploadRoutes)

// Health check route
app.get('/health', (req, res) => {
  res.status(200).json({
    success: true,
    message: 'Server is running',
    timestamp: new Date().toISOString()
  })
})

// Catch all route for undefined endpoints
app.all('*', (req, res) => {
  res.status(404).json({
    success: false,
    message: `Route ${req.originalUrl} not found`
  })
})

// Error handler middleware (should be last)
app.use(errorHandler)

const PORT = process.env.PORT || 5000

const server = app.listen(PORT, () => {
  console.log(`Server running in ${process.env.NODE_ENV} mode on port ${PORT}`)
})

// Handle unhandled promise rejections
process.on('unhandledRejection', (err, promise) => {
  console.log(`Unhandled Rejection: ${err.message}`)
  // Close server & exit process
  server.close(() => {
    process.exit(1)
  })
})

// Handle uncaught exceptions
process.on('uncaughtException', (err) => {
  console.log(`Uncaught Exception: ${err.message}`)
  console.log('Shutting down...')
  process.exit(1)
})

module.exports = app
```

## 2. App Configuration - src/app.js
```javascript
const express = require('express')
const cors = require('cors')
const cookieParser = require('cookie-parser')
const morgan = require('morgan')
const helmet = require('helmet')
const mongoSanitize = require('express-mongo-sanitize')
const xss = require('xss-clean')

const app = express()

// Security middleware
app.use(helmet())

// CORS configuration
app.use(cors({
  origin: function (origin, callback) {
    const allowedOrigins = [
      'http://localhost:3000',
      'http://localhost:5173',
      process.env.CLIENT_URL
    ].filter(Boolean)
    
    if (!origin || allowedOrigins.indexOf(origin) !== -1) {
      callback(null, true)
    } else {
      callback(new Error('Not allowed by CORS'))
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
}))

// Body parsing middleware
app.use(express.json({ limit: '10mb' }))
app.use(express.urlencoded({ extended: true, limit: '10mb' }))

// Cookie parser
app.use(cookieParser())

// Data sanitization
app.use(mongoSanitize())
app.use(xss())

// Logging
if (process.env.NODE_ENV === 'development') {
  app.use(morgan('combined'))
}

module.exports = app
```

## 3. Database Configuration - src/config/database.js
```javascript
const mongoose = require('mongoose')

const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
      serverSelectionTimeoutMS: 5000,
      socketTimeoutMS: 45000,
    })

    console.log(`MongoDB Connected: ${conn.connection.host}`)
    
    // Handle connection events
    mongoose.connection.on('connected', () => {
      console.log('Mongoose connected to MongoDB')
    })

    mongoose.connection.on('error', (err) => {
      console.error('Mongoose connection error:', err)
    })

    mongoose.connection.on('disconnected', () => {
      console.log('Mongoose disconnected')
    })

    // Graceful shutdown
    process.on('SIGINT', async () => {
      try {
        await mongoose.connection.close()
        console.log('MongoDB connection closed through app termination')
        process.exit(0)
      } catch (error) {
        console.error('Error during MongoDB shutdown:', error)
        process.exit(1)
      }
    })

  } catch (error) {
    console.error('Database connection failed:', error.message)
    process.exit(1)
  }
}

module.exports = connectDB
```

## 4. Response Helpers - src/utils/helpers/responseHelpers.js
```javascript
// Success response helper
const sendSuccessResponse = (res, data, message = 'Success', statusCode = 200) => {
  return res.status(statusCode).json({
    success: true,
    message,
    data,
    timestamp: new Date().toISOString()
  })
}

// Error response helper
const sendErrorResponse = (res, message = 'Something went wrong', statusCode = 500, errors = null) => {
  const response = {
    success: false,
    message,
    timestamp: new Date().toISOString()
  }

  if (errors) {
    response.errors = errors
  }

  return res.status(statusCode).json(response)
}

// Paginated response helper
const sendPaginatedResponse = (res, data, pagination, message = 'Success') => {
  return res.status(200).json({
    success: true,
    message,
    data,
    pagination: {
      page: pagination.page,
      limit: pagination.limit,
      total: pagination.total,
      pages: Math.ceil(pagination.total / pagination.limit),
      hasNext: pagination.page < Math.ceil(pagination.total / pagination.limit),
      hasPrev: pagination.page > 1
    },
    timestamp: new Date().toISOString()
  })
}

module.exports = {
  sendSuccessResponse,
  sendErrorResponse,
  sendPaginatedResponse
}
```

## 5. Logger Configuration - src/utils/logger/logger.js
```javascript
const winston = require('winston')
const path = require('path')

// Define log levels
const levels = {
  error: 0,
  warn: 1,
  info: 2,
  http: 3,
  debug: 4,
}

// Define colors for each level
const colors = {
  error: 'red',
  warn: 'yellow',
  info: 'green',
  http: 'magenta',
  debug: 'white',
}

// Add colors to winston
winston.addColors(colors)

// Define format for logs
const format = winston.format.combine(
  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss:ms' }),
  winston.format.colorize({ all: true }),
  winston.format.printf(
    (info) => `${info.timestamp} ${info.level}: ${info.message}`,
  ),
)

// Define which transports the logger must use
const transports = [
  // Console transport
  new winston.transports.Console({
    level: process.env.NODE_ENV === 'development' ? 'debug' : 'warn',
    format: winston.format.combine(
      winston.format.colorize(),
      winston.format.simple()
    )
  }),
  
  // File transport for errors
  new winston.transports.File({
    filename: path.join(__dirname, '../../../logs/error.log'),
    level: 'error',
    format: winston.format.combine(
      winston.format.uncolorize(),
      winston.format.json()
    )
  }),
  
  // File transport for all logs
  new winston.transports.File({
    filename: path.join(__dirname, '../../../logs/combined.log'),
    format: winston.format.combine(
      winston.format.uncolorize(),
      winston.format.json()
    )
  })
]

// Create the logger
const logger = winston.createLogger({
  level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
  levels,
  format,
  transports,
  exitOnError: false
})

module.exports = logger
```

## 6. Error Handler Middleware - src/middleware/errorHandler.js
```javascript
const logger = require('../utils/logger/logger')

const errorHandler = (err, req, res, next) => {
  let error = { ...err }
  error.message = err.message

  // Log error
  logger.error(`${err.message} - ${req.originalUrl} - ${req.method} - ${req.ip}`)

  // Mongoose bad ObjectId
  if (err.name === 'CastError') {
    const message = 'Resource not found'
    error = { message, statusCode: 404 }
  }

  // Mongoose duplicate key
  if (err.code === 11000) {
    const message = 'Duplicate field value entered'
    error = { message, statusCode: 400 }
  }

  // Mongoose validation error
  if (err.name === 'ValidationError') {
    const message = Object.values(err.errors).map(val => val.message).join(', ')
    error = { message, statusCode: 400 }
  }

  // JWT errors
  if (err.name === 'JsonWebTokenError') {
    const message = 'Invalid token'
    error = { message, statusCode: 401 }
  }

  if (err.name === 'TokenExpiredError') {
    const message = 'Token expired'
    error = { message, statusCode: 401 }
  }

  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'Server Error',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  })
}

module.exports = errorHandler
```

## 7. Email Service - src/services/email/emailService.js
```javascript
const nodemailer = require('nodemailer')
const logger = require('../../utils/logger/logger')

// Email templates
const welcomeTemplate = require('./templates/welcome')
const passwordResetTemplate = require('./templates/password-reset')

// Create transporter
const createTransporter = () => {
  return nodemailer.createTransporter({
    host: process.env.EMAIL_HOST,
    port: process.env.EMAIL_PORT,
    secure: process.env.EMAIL_PORT == 465, // true for 465, false for other ports
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASS
    },
    tls: {
      rejectUnauthorized: false
    }
  })
}

const sendEmail = async (options) => {
  try {
    const transporter = createTransporter()

    let htmlContent = ''
    let subject = options.subject

    // Generate HTML content based on template
    switch (options.template) {
      case 'welcome':
        htmlContent = welcomeTemplate(options.data)
        subject = subject || 'Welcome to Smart Booking'
        break
      case 'password-reset':
        htmlContent = passwordResetTemplate(options.data)
        subject = subject || 'Password Reset Request'
        break
      default:
        htmlContent = options.html || options.text || ''
    }

    const message = {
      from: `${process.env.FROM_NAME || 'Smart Booking'} <${process.env.EMAIL_FROM}>`,
      to: options.email,
      subject: subject,
      html: htmlContent,
      text: options.text
    }

    const info = await transporter.sendMail(message)
    
    logger.info(`Email sent to ${options.email}: ${info.messageId}`)
    
    return {
      success: true,
      messageId: info.messageId
    }
  } catch (error) {
    logger.error('Email sending failed:', error)
    throw error
  }
}

module.exports = { sendEmail }
```

## 8. Welcome Email Template - src/services/email/templates/welcome.js
```javascript
const welcomeTemplate = (data) => {
  const { firstName, verificationUrl, verificationToken } = data

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Welcome to Smart Booking</title>
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: #3B82F6; color: white; padding: 20px; text-align: center; }
        .content { padding: 20px; background: #f9f9f9; }
        .button { display: inline-block; background: #3B82F6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Welcome to Smart Booking!</h1>
        </div>
        <div class="content">
          <h2>Hello ${firstName}!</h2>
          <p>Thank you for joining Smart Booking. We're excited to have you on board!</p>
          <p>To get started, please verify your email address by clicking the button below:</p>
          <a href="${verificationUrl}" class="button">Verify Email Address</a>
          <p>If the button doesn't work, copy and paste this link into your browser:</p>
          <p><a href="${verificationUrl}">${verificationUrl}</a></p>
          <p>This link will expire in 24 hours for security reasons.</p>
          <p>If you didn't create an account with us, please ignore this email.</p>
          <p>Best regards,<br>The Smart Booking Team</p>
        </div>
        <div class="footer">
          <p>&copy; 2025 Smart Booking. All rights reserved.</p>
        </div>
      </div>
    </body>
    </html>
  `
}

module.exports = welcomeTemplate
```

## 9. Password Reset Email Template - src/services/email/templates/password-reset.js
```javascript
const passwordResetTemplate = (data) => {
  const { firstName, resetUrl, resetToken } = data

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Password Reset - Smart Booking</title>
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: #EF4444; color: white; padding: 20px; text-align: center; }
        .content { padding: 20px; background: #f9f9f9; }
        .button { display: inline-block; background: #EF4444; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
        .warning { background: #FEF2F2; border: 1px solid #FECACA; padding: 15px; border-radius: 5px; margin: 20px 0; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Password Reset Request</h1>
        </div>
        <div class="content">
          <h2>Hello ${firstName}!</h2>
          <p>We received a request to reset your password for your Smart Booking account.</p>
          <p>Click the button below to reset your password:</p>
          <a href="${resetUrl}" class="button">Reset Password</a>
          <p>If the button doesn't work, copy and paste this link into your browser:</p>
          <p><a href="${resetUrl}">${resetUrl}</a></p>
          <div class="warning">
            <strong>Important:</strong>
            <ul>
              <li>This link will expire in 10 minutes for security reasons</li>
              <li>If you didn't request this password reset, please ignore this email</li>
              <li>Your password will not be changed unless you click the link above</li>
            </ul>
          </div>
          <p>If you continue to have trouble, please contact our support team.</p>
          <p>Best regards,<br>The Smart Booking Team</p>
        </div>
        <div class="footer">
          <p>&copy; 2025 Smart Booking. All rights reserved.</p>
        </div>
      </div>
    </body>
    </html>
  `
}

module.exports = passwordResetTemplate
```

## 10. User Routes - src/routes/users.js
```javascript
const express = require('express')
const { protect, authorize } = require('../middleware/auth')
const {
  getUsers,
  getUser,
  updateUser,
  deleteUser
} = require('../controllers/userController')

const router = express.Router()

// All routes are protected and require authentication
router.use(protect)

router
  .route('/')
  .get(authorize('admin'), getUsers)

router
  .route('/:id')
  .get(getUser)
  .put(updateUser)
  .delete(deleteUser)

module.exports = router
```

## 11. Package.json
```json
{
  "name": "smart-booking-backend",
  "version": "1.0.0",
  "description": "Backend API for Smart Booking System",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "jest",
    "test:watch": "jest --watch"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mongoose": "^7.5.0",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "cookie-parser": "^1.4.6",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "express-validator": "^7.0.1",
    "nodemailer": "^6.9.4",
    "winston": "^3.10.0",
    "helmet": "^7.0.0",
    "express-rate-limit": "^6.10.0",
    "express-mongo-sanitize": "^2.2.0",
    "xss-clean": "^0.1.1",
    "hpp": "^0.2.3",
    "morgan": "^1.10.0",
    "crypto": "^1.0.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.1",
    "jest": "^29.6.4",
    "supertest": "^6.3.3"
  },
  "keywords": [
    "booking",
    "appointments",
    "api",
    "express",
    "mongodb"
  ],
  "author": "Your Name",
  "license": "MIT"
}
```

## 12. User Controller - src/controllers/userController.js
```javascript
const User = require('../models/User')
const { sendSuccessResponse, sendErrorResponse } = require('../utils/helpers/responseHelpers')
const logger = require('../utils/logger/logger')

// @desc    Get all users
// @route   GET /api/users
// @access  Private/Admin
exports.getUsers = async (req, res) => {
  try {
    const page = parseInt(req.query.page, 10) || 1
    const limit = parseInt(req.query.limit, 10) || 10
    const startIndex = (page - 1) * limit

    const total = await User.countDocuments({ isActive: true })
    const users = await User.find({ isActive: true })
      .select('-password')
      .sort({ createdAt: -1 })
      .limit(limit)
      .skip(startIndex)

    const pagination = {
      page,
      limit,
      total,
      pages: Math.ceil(total / limit)
    }

    res.status(200).json({
      success: true,
      data: users,
      pagination,
      count: users.length
    })
  } catch (error) {
    logger.error('Get users error:', error)
    sendErrorResponse(res, 'Failed to fetch users', 500)
  }
}

// @desc    Get single user
// @route   GET /api/users/:id
// @access  Private
exports.getUser = async (req, res) => {
  try {
    const user = await User.findById(req.params.id).select('-password')

    if (!user) {
      return sendErrorResponse(res, 'User not found', 404)
    }

    // Users can only get their own data unless they're admin
    if (user._id.toString() !== req.user.id && req.user.role !== 'admin') {
      return sendErrorResponse(res, 'Not authorized to access this user', 403)
    }

    sendSuccessResponse(res, user, 'User retrieved successfully')
  } catch (error) {
    logger.error('Get user error:', error)
    sendErrorResponse(res, 'Failed to get user', 500)
  }
}

// @desc    Update user
// @route   PUT /api/users/:id
// @access  Private
exports.updateUser = async (req, res) => {
  try {
    let user = await User.findById(req.params.id)

    if (!user) {
      return sendErrorResponse(res, 'User not found', 404)
    }

    // Users can only update their own data unless they're admin
    if (user._id.toString() !== req.user.id && req.user.role !== 'admin') {
      return sendErrorResponse(res, 'Not authorized to update this user', 403)
    }

    // Fields that can be updated
    const allowedFields = ['firstName', 'lastName', 'phone', 'preferences', 'profileImage']
    
    // Only admin can update role and verification status
    if (req.user.role === 'admin') {
      allowedFields.push('role', 'isVerified', 'isActive')
    }

    const fieldsToUpdate = {}
    Object.keys(req.body).forEach(key => {
      if (allowedFields.includes(key)) {
        fieldsToUpdate[key] = req.body[key]
      }
    })

    user = await User.findByIdAndUpdate(
      req.params.id,
      fieldsToUpdate,
      {
        new: true,
        runValidators: true
      }
    ).select('-password')

    sendSuccessResponse(res, user, 'User updated successfully')
  } catch (error) {
    logger.error('Update user error:', error)
    
    if (error.name === 'ValidationError') {
      const message = Object.values(error.errors).map(val => val.message).join(', ')
      return sendErrorResponse(res, message, 400)
    }

    sendErrorResponse(res, 'Failed to update user', 500)
  }
}

// @desc    Delete user
// @route   DELETE /api/users/:id
// @access  Private
exports.deleteUser = async (req, res) => {
  try {
    const user = await User.findById(req.params.id)

    if (!user) {
      return sendErrorResponse(res, 'User not found', 404)
    }

    // Users can only delete their own account unless they're admin
    if (user._id.toString() !== req.user.id && req.user.role !== 'admin') {
      return sendErrorResponse(res, 'Not authorized to delete this user', 403)
    }

    // Soft delete - set isActive to false instead of actually deleting
    await User.findByIdAndUpdate(req.params.id, { isActive: false })

    sendSuccessResponse(res, null, 'User account deactivated successfully')
  } catch (error) {
    logger.error('Delete user error:', error)
    sendErrorResponse(res, 'Failed to delete user', 500)
  }
}
```

## Usage Instructions

1. **Install dependencies:**
```bash
npm install
```

2. **Create .env file in root:**
```env
NODE_ENV=development
PORT=5000
CLIENT_URL=http://localhost:3000

MONGODB_URI=mongodb://localhost:27017/smart-booking

JWT_SECRET=your-super-secret-jwt-key-here-make-it-very-long-and-complex
JWT_EXPIRE=7d
JWT_COOKIE_EXPIRE=7

EMAIL_FROM=noreply@smartbooking.com
FROM_NAME=Smart Booking
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
```

3. **Create required directories:**
```bash
mkdir -p logs uploads/profiles uploads/services uploads/temp
```

4. **Start the server:**
```bash
npm run dev
```

5. **Test API endpoints:**
- POST `/api/auth/register` - Register new user
- POST `/api/auth/login` - Login user
- GET `/api/auth/me` - Get current user (requires auth)
- GET `/health` - Health check

This backend setup provides:
- Complete authentication system with JWT
- Email verification and password reset
- Secure API endpoints with proper error handling
- Rate limiting and security middleware
- File upload support
- Comprehensive logging
- MongoDB integration
- CORS configuration for your React frontend

The system will now work properly with your React frontend authentication context.